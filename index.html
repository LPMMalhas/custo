<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custo Confecção App - LPM</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background: white; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- MÓDULO FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // CONFIGURAÇÃO DO FIREBASE (LPM CUSTOS)
        const firebaseConfig = {
            apiKey: "AIzaSyB_NhBARgU0yzluBZl0LI43bKqdmjsFyO4",
            authDomain: "lpm-custos.firebaseapp.com",
            projectId: "lpm-custos",
            storageBucket: "lpm-custos.firebasestorage.app",
            messagingSenderId: "658666837196",
            appId: "1:658666837196:web:7c95cfda27fc19590b5e69"
        };

        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            // Login anónimo para permitir leitura/escrita segura por utilizador
            signInAnonymously(auth).catch((error) => console.error("Erro auth:", error));
        } catch (e) {
            console.error("Erro Firebase:", e);
        }

        // Expor serviços para o React
        window.AppServices = { db, auth, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, onAuthStateChanged };
    </script>

    <!-- CÓDIGO DA APLICAÇÃO (REACT) -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- HOOK DE DADOS (CONECTADO AO FIREBASE) ---
        const useData = (collectionName, defaultValue) => {
            const [data, setData] = useState(defaultValue);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const checkServices = setInterval(() => {
                    if (window.AppServices && window.AppServices.auth) {
                        clearInterval(checkServices);
                        initListener();
                    }
                }, 100);

                const initListener = () => {
                    const { auth, db, collection, onSnapshot, query, onAuthStateChanged } = window.AppServices;
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            // Cria coleção por usuário para segurança dos dados
                            const q = query(collection(db, `users/${user.uid}/${collectionName}`));
                            const unsubscribe = onSnapshot(q, (snapshot) => {
                                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                // Se houver dados, usa. Se não, e for a primeira vez, mantém vazio (não injeta default no banco para não sujar)
                                if (items.length > 0) setData(items);
                                else if (defaultValue && defaultValue.length > 0 && items.length === 0) {
                                    // Mantém default visualmente apenas
                                    setData(defaultValue);
                                } else {
                                    setData([]);
                                }
                                setLoading(false);
                            });
                            return () => unsubscribe();
                        } else {
                            setLoading(false);
                        }
                    });
                };
                return () => clearInterval(checkServices);
            }, [collectionName]);

            // Funções CRUD Firebase
            const add = async (item) => {
                const { auth, db, collection, addDoc } = window.AppServices;
                if (!auth.currentUser) return;
                const { id, ...cleanItem } = item; // Remove ID local temporário
                await addDoc(collection(db, `users/${auth.currentUser.uid}/${collectionName}`), cleanItem);
            };

            const update = async (item) => {
                const { auth, db, doc, updateDoc } = window.AppServices;
                if (!auth.currentUser || !item.id) return;
                // Se o ID for numérico (default data), trata como novo insert pois ainda não existe no banco
                if (typeof item.id === 'number') { add(item); return; }
                const { id, ...cleanItem } = item;
                await updateDoc(doc(db, `users/${auth.currentUser.uid}/${collectionName}`, id), cleanItem);
            };

            const remove = async (id) => {
                const { auth, db, doc, deleteDoc } = window.AppServices;
                if (!auth.currentUser || !id) return;
                if (typeof id === 'number') { setData(prev => prev.filter(i => i.id !== id)); return; }
                await deleteDoc(doc(db, `users/${auth.currentUser.uid}/${collectionName}`, id));
            };

            return [data, add, update, remove, loading];
        };

        // --- Helper: LocalStorage Hook (Mantido para navegação local simples) ---
        const useStickyState = (defaultValue, key) => {
            const [value, setValue] = useState(() => {
                const stickyValue = window.localStorage.getItem(key);
                return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
            });
            useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        };

        const capitalize = (str) => {
            if (typeof str !== 'string' || str.length === 0) return str;
            return str.toLowerCase().replace(/(?:^|\s|["'([{])+\S/g, match => match.toUpperCase());
        };

        // --- Componentes de Ícones (Lucide) ---
        const Icon = ({ name, size = 24, color = "currentColor", className="" }) => {
            if (!window.lucide) return null;
            return <i data-lucide={name} className={className} style={{ width: size, height: size, color: color, display: 'inline-block' }}></i>;
        };

        const IconWrapper = (props) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });
            return <i data-lucide={props.name} className={props.className} style={{ width: props.size, height: props.size, color: props.color }}></i>
        }

        const MenuCard = ({ title, subtitle, icon, color, onClick }) => (
            <div onClick={onClick} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between mb-4 cursor-pointer hover:shadow-md transition-all active:scale-95">
                <div className="flex items-center gap-4">
                    <div className={`p-3 rounded-xl ${color} text-white flex items-center justify-center`}><IconWrapper name={icon} size={24} /></div>
                    <div><h3 className="font-bold text-gray-800 text-lg">{title}</h3><p className="text-gray-500 text-sm">{subtitle}</p></div>
                </div>
                <div className="text-gray-300"><IconWrapper name="chevron-right" size={20} /></div>
            </div>
        );

        const SummaryCard = () => (
            <div className="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl p-6 text-white shadow-xl mb-8 relative overflow-hidden">
                <div className="relative z-10">
                    <p className="text-slate-300 text-sm font-medium mb-1">Último Produto Calculado</p>
                    <h2 className="text-2xl font-bold mb-2">LPM Malhas</h2>
                    <div className="flex items-center gap-2">
                        <span className="bg-green-500/20 text-green-300 px-2 py-0.5 rounded text-xs font-bold border border-green-500/30">Sistema Online</span>
                    </div>
                </div>
                <div className="absolute -right-6 -bottom-6 opacity-10 text-white"><IconWrapper name="shirt" size={120} /></div>
            </div>
        );

        // --- SCREENS ---
        const HomeScreen = ({ setScreen }) => (
            <div className="p-6 pb-24 animate-fade-in">
                <header className="flex justify-between items-center mb-6">
                    <div><h1 className="text-2xl font-bold text-slate-800">Confecção Cost</h1><p className="text-gray-500 text-sm">Controle sua produção</p></div>
                    <div className="flex gap-2">
                         <button onClick={() => setScreen('settings')} className="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-600 shadow-sm hover:bg-slate-200"><IconWrapper name="settings" size={20} /></button>
                         <div className="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center text-slate-600 font-bold border-2 border-white shadow-sm">C</div>
                    </div>
                </header>
                <SummaryCard />
                <h2 className="text-slate-800 font-bold mb-4 text-lg">Menu Principal</h2>
                <MenuCard title="Novo Cálculo" subtitle="Criar ficha técnica de custo" icon="calculator" color="bg-blue-600" onClick={() => setScreen('calculator')} />
                <MenuCard title="Meus Clientes" subtitle="Custos por cliente" icon="users" color="bg-orange-500" onClick={() => setScreen('clients')} />
                <MenuCard title="Meus Tecidos" subtitle="Gerenciar matéria-prima" icon="scissors" color="bg-pink-500" onClick={() => setScreen('fabrics')} />
                <MenuCard title="Meus Produtos" subtitle="Ver histórico e preços" icon="shirt" color="bg-emerald-500" onClick={() => setScreen('search')} />
                <h2 className="text-slate-800 font-bold mb-4 mt-6 text-lg">Financeiro</h2>
                <MenuCard title="Custos Fixos" subtitle="Aluguel, Luz..." icon="dollar-sign" color="bg-indigo-500" onClick={() => setScreen('fixedCosts')} />
                <MenuCard title="Custos Variáveis" subtitle="Impostos, Comissões" icon="percent" color="bg-violet-500" onClick={() => setScreen('variableCosts')} />
            </div>
        );

        const ClientDetail = ({ client, onBack, onSave }) => {
            const [formData, setFormData] = useState({ ...client, extraFields: client.extraFields || [], inputs: client.inputs || [] });
            const handleChange = (e) => setFormData({...formData, [e.target.name]: ['name','representative','paymentTerms'].includes(e.target.name) ? capitalize(e.target.value) : (parseFloat(e.target.value)||0)});
            
            const handleAddInput = () => setFormData(prev => ({ ...prev, inputs: [...prev.inputs, { id: Date.now(), name: "", cost: 0 }] }));
            const handleUpdateInput = (idx, field, val) => { const n = [...formData.inputs]; n[idx][field] = field === 'cost' ? parseFloat(val)||0 : capitalize(val); setFormData(prev => ({ ...prev, inputs: n })); };
            const handleRemoveInput = (idx) => setFormData(prev => ({ ...prev, inputs: prev.inputs.filter((_, i) => i !== idx) }));

            const handleAddExtra = () => setFormData(prev => ({ ...prev, extraFields: [...prev.extraFields, { id: Date.now(), label: "", value: "" }] }));
            const handleUpdateExtra = (idx, field, val) => { const n = [...formData.extraFields]; n[idx][field] = capitalize(val); setFormData(prev => ({ ...prev, extraFields: n })); };
            const handleRemoveExtra = (idx) => setFormData(prev => ({ ...prev, extraFields: prev.extraFields.filter((_, i) => i !== idx) }));

            return (
                <div className="p-6 pb-24 min-h-screen bg-gray-50">
                    <div className="flex items-center gap-3 mb-6"><button onClick={onBack} className="p-2 bg-white rounded-lg shadow-sm border border-gray-100 text-gray-600"><IconWrapper name="arrow-left" size={20}/></button><h1 className="text-xl font-bold">Editar Cliente</h1></div>
                    <div className="bg-white p-6 rounded-2xl shadow-sm border mb-6 space-y-4">
                        <input name="name" value={formData.name} onChange={handleChange} placeholder="Nome" className="w-full p-3 border rounded-lg"/>
                        <input name="representative" value={formData.representative||''} onChange={handleChange} placeholder="Representante" className="w-full p-3 border rounded-lg"/>
                        <input name="paymentTerms" value={formData.paymentTerms||''} onChange={handleChange} placeholder="Prazo Pagto" className="w-full p-3 border rounded-lg"/>
                    </div>
                    <h3 className="font-bold mb-2">Taxas (%)</h3>
                    <div className="bg-white p-6 rounded-2xl shadow-sm border mb-6 grid grid-cols-2 gap-4 text-xs">
                        <div>Comissão <input type="number" step="0.1" name="commission" value={formData.commission} onChange={handleChange} className="w-full p-2 border rounded"/></div>
                        <div>Impostos <input type="number" step="0.1" name="tax" value={formData.tax} onChange={handleChange} className="w-full p-2 border rounded"/></div>
                        <div>MD <input type="number" step="0.1" name="expenses" value={formData.expenses} onChange={handleChange} className="w-full p-2 border rounded"/></div>
                        <div>Financeiro <input type="number" step="0.1" name="financial" value={formData.financial} onChange={handleChange} className="w-full p-2 border rounded"/></div>
                        <div>Negociação <input type="number" step="0.1" name="negotiation" value={formData.negotiation} onChange={handleChange} className="w-full p-2 border rounded"/></div>
                        <div>Lucro <input type="number" step="0.1" name="margin" value={formData.margin} onChange={handleChange} className="w-full p-2 border rounded"/></div>
                        <div>Frete <input type="number" step="0.1" name="freight" value={formData.freight} onChange={handleChange} className="w-full p-2 border rounded"/></div>
                    </div>
                    <div className="flex justify-between mb-2"><h3 className="font-bold">Insumos Cliente</h3><button onClick={handleAddInput} className="text-blue-600 font-bold text-sm">+ Add</button></div>
                    <div className="bg-white p-6 rounded-2xl shadow-sm border mb-6 space-y-2">
                        {formData.inputs.length === 0 && <p className="text-center text-gray-400 text-xs py-2">Sem insumos específicos</p>}
                        {formData.inputs.map((inp, i) => (
                            <div key={inp.id} className="flex gap-2"><input className="flex-1 p-2 border rounded text-sm" placeholder="Nome" value={inp.name} onChange={e=>handleUpdateInput(i,'name',e.target.value)} /><input className="w-24 p-2 border rounded text-sm" type="number" step="0.01" value={inp.cost} onChange={e=>handleUpdateInput(i,'cost',e.target.value)} /><button onClick={()=>handleRemoveInput(i)} className="text-red-400"><IconWrapper name="trash-2" size={18}/></button></div>
                        ))}
                    </div>
                    <div className="flex justify-between mb-2"><h3 className="font-bold">Extras</h3><button onClick={handleAddExtra} className="text-blue-600 font-bold text-sm">+ Add</button></div>
                    <div className="bg-white p-6 rounded-2xl shadow-sm border mb-6 space-y-2">
                        {formData.extraFields.map((ex, i) => (
                            <div key={ex.id} className="flex gap-2"><input className="flex-1 p-2 border rounded text-sm" placeholder="Campo" value={ex.label} onChange={e=>handleUpdateExtra(i,'label',e.target.value)} /><input className="flex-1 p-2 border rounded text-sm" placeholder="Valor" value={ex.value} onChange={e=>handleUpdateExtra(i,'value',e.target.value)} /><button onClick={()=>handleRemoveExtra(i)} className="text-red-400"><IconWrapper name="trash-2" size={16}/></button></div>
                        ))}
                    </div>
                    <button onClick={() => onSave(formData)} className="w-full py-4 bg-blue-600 text-white rounded-xl font-bold">Salvar</button>
                </div>
            );
        };

        const ClientsScreen = ({ setScreen, clients, onAddClient, onDeleteClient, onUpdateClient }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [newClientName, setNewClientName] = useState("");
            const [selectedClient, setSelectedClient] = useState(null);
            
            const handleSave = () => {
                if (newClientName.trim()) { onAddClient({ name: newClientName }); setNewClientName(""); setIsModalOpen(false); }
            };

            if (selectedClient) return <ClientDetail client={selectedClient} onBack={() => setSelectedClient(null)} onSave={(data) => { onUpdateClient(data); setSelectedClient(null); }} />;

            return (
                <div className="p-6 pb-24 min-h-screen relative">
                    <div className="flex items-center gap-3 mb-6"><button onClick={() => setScreen('home')} className="p-2 bg-white rounded-lg shadow-sm border text-gray-600"><IconWrapper name="arrow-left" size={20}/></button><h1 className="text-xl font-bold">Clientes</h1></div>
                    <div className="space-y-3">{clients.map(c => (
                        <div key={c.id} onClick={() => setSelectedClient(c)} className="bg-white p-4 rounded-xl shadow-sm border flex justify-between items-center cursor-pointer">
                            <div className="flex items-center gap-3"><div className="bg-orange-100 p-3 rounded-full text-orange-600"><IconWrapper name="users" size={20}/></div><h3 className="font-bold">{c.name}</h3></div>
                            <button onClick={(e) => {e.stopPropagation(); onDeleteClient(c.id)}} className="text-gray-300 hover:text-red-500"><IconWrapper name="trash-2" size={20}/></button>
                        </div>
                    ))}</div>
                    <button onClick={() => setIsModalOpen(true)} className="mt-6 w-full py-4 bg-blue-600 text-white rounded-xl font-bold shadow-lg flex justify-center gap-2"><IconWrapper name="plus" size={20}/> Adicionar</button>
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                                <h3 className="font-bold mb-4">Novo Cliente</h3>
                                <input value={newClientName} onChange={e => setNewClientName(capitalize(e.target.value))} placeholder="Nome" className="w-full p-3 border rounded-lg mb-4"/>
                                <div className="flex gap-3"><button onClick={() => setIsModalOpen(false)} className="flex-1 py-3 bg-gray-100 rounded-lg">Cancelar</button><button onClick={handleSave} className="flex-1 py-3 bg-blue-600 text-white rounded-lg">Salvar</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const FabricDetail = ({ fabric, onBack, onSave }) => {
            const [formData, setFormData] = useState({ ...fabric, yarns: fabric.yarns || [], extraFields: fabric.extraFields || [] });
            
            useEffect(() => {
                let totalYarn = 0;
                formData.yarns.forEach(y => totalYarn += (y.price * (y.percentage/100)));
                const effWeav = 1 - ((formData.weavingBreakage||0)/100);
                const greige = (effWeav > 0 ? totalYarn/effWeav : totalYarn) + (formData.weavingCost||0);
                
                let activeColors = 0, sumColors = 0;
                if(formData.colorCost1 > 0) { sumColors += formData.colorCost1; activeColors++; }
                if(formData.colorCost2 > 0) { sumColors += formData.colorCost2; activeColors++; }
                if(formData.colorCost3 > 0) { sumColors += formData.colorCost3; activeColors++; }
                const avgColor = activeColors > 0 ? sumColors/activeColors : 0;
                
                const effDye = 1 - ((formData.dyeingBreakage||0)/100);
                const subTotal = greige + avgColor; 
                const final = effDye > 0 ? subTotal / effDye : subTotal; 
                
                if(final !== formData.price || avgColor !== formData.dyeingCost) {
                    setFormData(prev => ({...prev, price: parseFloat(final.toFixed(2)), dyeingCost: parseFloat(avgColor.toFixed(2)) }));
                }
            }, [formData.yarns, formData.weavingCost, formData.weavingBreakage, formData.colorCost1, formData.colorCost2, formData.colorCost3, formData.dyeingBreakage]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                let val = value;
                if (['weavingCost','weavingBreakage','colorCost1','colorCost2','colorCost3','dyeingBreakage','price','yield'].includes(name)) val = parseFloat(value)||0;
                else if (typeof value === 'string') val = capitalize(value);
                setFormData(prev => ({...prev, [name]: val}));
            };

            const handleUpdateYarn = (idx, field, val) => {
                const ny = [...formData.yarns];
                ny[idx][field] = field === 'type' ? capitalize(val) : parseFloat(val)||0;
                setFormData(prev => ({...prev, yarns: ny}));
            };

            const handleRemoveYarn = (index) => {
                const newYarns = formData.yarns.filter((_, i) => i !== index);
                setFormData(prev => ({ ...prev, yarns: newYarns }));
            };
            
            return (
                <div className="p-6 pb-24 min-h-screen bg-gray-50">
                    <div className="flex items-center gap-3 mb-6"><button onClick={onBack} className="p-2 bg-white rounded-lg shadow-sm border border-gray-100 text-gray-600"><IconWrapper name="arrow-left" size={20}/></button><h1 className="text-xl font-bold">Editar Tecido</h1></div>
                    <div className="bg-white p-6 rounded-2xl shadow-sm border mb-6 space-y-4">
                        <input name="name" value={formData.name} onChange={handleChange} placeholder="Nome" className="w-full p-3 border rounded-lg"/>
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="text-xs">Unidade</label><select name="type" value={formData.type} onChange={handleChange} className="w-full p-3 border rounded-lg"><option value="Kg">Kg</option><option value="M">M</option></select></div>
                            <div><label className="text-xs font-bold text-pink-600">Preço Final</label><input type="number" value={formData.price} readOnly className="w-full p-3 bg-pink-50 border border-pink-200 rounded-lg text-pink-700 font-bold"/></div>
                        </div>
                        <div><label className="text-xs text-gray-500">Rendimento (Mts/Kg)</label><input type="number" step="0.01" name="yield" value={formData.yield||''} onChange={handleChange} className="w-full p-3 border rounded-lg"/></div>
                    </div>
                    {/* Fios Section */}
                    <div className="bg-white p-6 rounded-2xl shadow-sm border mb-6 space-y-4">
                        <div className="flex justify-between"><h3 className="font-bold">Fios</h3><button onClick={() => setFormData(prev => ({...prev, yarns: [...prev.yarns, {id: Date.now(), type:"", percentage:0, price:0}]}))} className="text-pink-600 font-bold text-xs">+ Add</button></div>
                        {formData.yarns.map((y, i) => (
                            <div key={y.id} className="grid grid-cols-12 gap-2 text-xs relative">
                                <input className="col-span-5 p-2 border rounded" placeholder="Tipo" value={y.type} onChange={(e) => handleUpdateYarn(i, 'type', e.target.value)} />
                                <div className="col-span-3 relative"><input className="w-full p-2 pr-4 border rounded" placeholder="%" type="number" value={y.percentage} onChange={(e) => handleUpdateYarn(i, 'percentage', e.target.value)} /><span className="absolute right-1 top-2 text-gray-400">%</span></div>
                                <div className="col-span-3 relative"><input className="w-full p-2 pl-4 border rounded" placeholder="R$" type="number" value={y.price} onChange={(e) => handleUpdateYarn(i, 'price', e.target.value)} /><span className="absolute left-1 top-2 text-gray-400">R$</span></div>
                                <button onClick={() => setFormData(prev => ({...prev, yarns: prev.yarns.filter((_, idx) => idx !== i)}))} className="col-span-1 text-red-500"><IconWrapper name="trash-2" size={16}/></button>
                            </div>
                        ))}
                    </div>
                    {/* Prod Costs */}
                    <div className="bg-white p-6 rounded-2xl shadow-sm border mb-6 space-y-4">
                        <h3 className="font-bold">Produção</h3>
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="text-xs">Tecelagem R$</label><input type="number" name="weavingCost" value={formData.weavingCost} onChange={handleChange} className="w-full p-2 border rounded"/></div>
                            <div><label className="text-xs">Quebra Tec %</label><input type="number" name="weavingBreakage" value={formData.weavingBreakage} onChange={handleChange} className="w-full p-2 border rounded"/></div>
                        </div>
                        <div className="grid grid-cols-3 gap-2">
                            <input type="number" placeholder="Cor 1" name="colorCost1" value={formData.colorCost1} onChange={handleChange} className="p-2 border rounded text-center"/>
                            <input type="number" placeholder="Cor 2" name="colorCost2" value={formData.colorCost2} onChange={handleChange} className="p-2 border rounded text-center"/>
                            <input type="number" placeholder="Cor 3" name="colorCost3" value={formData.colorCost3} onChange={handleChange} className="p-2 border rounded text-center"/>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="text-xs">Média Tint. R$</label><input type="number" value={formData.dyeingCost} readOnly className="w-full p-2 bg-gray-100 border rounded"/></div>
                            <div><label className="text-xs">Quebra Tint %</label><input type="number" name="dyeingBreakage" value={formData.dyeingBreakage} onChange={handleChange} className="w-full p-2 border rounded"/></div>
                        </div>
                    </div>
                    <button onClick={() => onSave(formData)} className="w-full py-4 bg-pink-600 text-white rounded-xl font-bold">Salvar</button>
                </div>
            );
        };

        const FabricsScreen = ({ setScreen, fabrics, onAddFabric, onDeleteFabric, onUpdateFabric }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [newFabricName, setNewFabricName] = useState("");
            const [selectedFabric, setSelectedFabric] = useState(null);
            
            const handleSave = () => { if(newFabricName.trim()) { onAddFabric({ name: newFabricName }); setNewFabricName(""); setIsModalOpen(false); } };
            
            if(selectedFabric) return <FabricDetail fabric={selectedFabric} onBack={() => setSelectedFabric(null)} onSave={(d) => { onUpdateFabric(d); setSelectedFabric(null); }} />;

            return (
                <div className="p-6 pb-24 min-h-screen relative">
                    <div className="flex items-center gap-3 mb-6"><button onClick={() => setScreen('home')} className="p-2 bg-white rounded-lg shadow-sm border border-gray-100 text-gray-600"><IconWrapper name="arrow-left" size={20}/></button><h1 className="text-xl font-bold text-slate-800">Meus Tecidos</h1></div>
                    <div className="space-y-3">{fabrics.map(f => (
                        <div key={f.id} onClick={() => setSelectedFabric(f)} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer">
                            <div className="flex items-center gap-3"><div className="bg-pink-100 p-3 rounded-full text-pink-600"><IconWrapper name={f.type === 'Kg' ? 'scale' : 'ruler'} size={20}/></div><div><h3 className="font-bold text-gray-800 text-sm">{f.name}</h3><p className="text-xs text-gray-500">R$ {f.price.toFixed(2)} / {f.type}</p></div></div>
                            <button onClick={(e) => { e.stopPropagation(); onDeleteFabric(f.id); }} className="text-gray-300 hover:text-red-500"><IconWrapper name="trash-2" size={20}/></button>
                        </div>
                    ))}</div>
                    <button onClick={() => setIsModalOpen(true)} className="mt-6 w-full py-4 bg-pink-600 text-white rounded-xl font-bold shadow-lg flex justify-center gap-2"><IconWrapper name="plus" size={20}/> Cadastrar Tecido</button>
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                                <h3 className="font-bold mb-4">Novo Tecido</h3>
                                <input value={newFabricName} onChange={(e) => setNewFabricName(capitalize(e.target.value))} placeholder="Nome" className="w-full p-3 border rounded-lg mb-4"/>
                                <div className="flex gap-3"><button onClick={() => setIsModalOpen(false)} className="flex-1 py-3 bg-gray-100 rounded-lg">Cancelar</button><button onClick={handleSave} className="flex-1 py-3 bg-pink-600 text-white rounded-lg">Salvar</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const FixedCostsScreen = ({ setScreen, costs, onAddCost, onDeleteCost, onUpdateCost }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [data, setData] = useState({ name: "", value: "" });
            const [editingId, setEditingId] = useState(null);

            const openEdit = (c) => { setData({ name: c.name, value: c.value }); setEditingId(c.id); setIsModalOpen(true); };
            const openNew = () => { setData({ name: "", value: "" }); setEditingId(null); setIsModalOpen(true); };
            const handleSave = () => {
                if(data.name && data.value) {
                    const val = parseFloat(data.value.toString().replace(',','.'));
                    if(editingId) onUpdateCost({ id: editingId, name: data.name, value: val });
                    else onAddCost({ name: data.name, value: val });
                    setIsModalOpen(false);
                }
            };
            const total = costs.reduce((a, b) => a + b.value, 0);

            return (
                <div className="p-6 pb-24 min-h-screen bg-gray-50 relative">
                    <div className="flex items-center gap-3 mb-6"><button onClick={() => setScreen('home')} className="p-2 bg-white rounded-lg shadow-sm border border-gray-100 text-gray-600"><IconWrapper name="arrow-left" size={20}/></button><h1 className="text-xl font-bold">Custos Fixos</h1></div>
                    <div className="bg-indigo-600 rounded-2xl p-6 text-white mb-6 shadow-lg"><p className="text-indigo-200 text-sm">Total Mensal</p><h2 className="text-3xl font-bold">R$ {total.toFixed(2)}</h2></div>
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">{costs.map(c => (
                        <div key={c.id} onClick={() => openEdit(c)} className="p-4 flex justify-between items-center border-b last:border-0 cursor-pointer hover:bg-gray-50">
                            <span className="font-medium text-gray-700">{c.name}</span>
                            <div className="flex gap-4 items-center"><span className="font-bold">R$ {c.value.toFixed(2)}</span><button onClick={(e) => {e.stopPropagation(); onDeleteCost(c.id)}} className="text-gray-300 hover:text-red-500"><IconWrapper name="trash-2" size={18}/></button></div>
                        </div>
                    ))}</div>
                    <button onClick={openNew} className="mt-6 w-full py-4 bg-indigo-600 text-white rounded-xl font-bold shadow-lg flex justify-center gap-2"><IconWrapper name="plus" size={20}/> Adicionar Custo</button>
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                                <h3 className="font-bold mb-4">{editingId ? 'Editar' : 'Novo'} Custo</h3>
                                <input value={data.name} onChange={(e) => setData({...data, name: capitalize(e.target.value)})} placeholder="Nome" className="w-full p-3 border rounded-lg mb-4"/>
                                <input type="number" step="0.01" value={data.value} onChange={(e) => setData({...data, value: e.target.value})} placeholder="Valor" className="w-full p-3 border rounded-lg mb-4"/>
                                <div className="flex gap-3"><button onClick={() => setIsModalOpen(false)} className="flex-1 py-3 bg-gray-100 rounded-lg">Cancelar</button><button onClick={handleSave} className="flex-1 py-3 bg-indigo-600 text-white rounded-lg">Salvar</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const VariableCostsScreen = ({ setScreen, costs, onAddCost, onDeleteCost, onUpdateCost }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [data, setData] = useState({ name: "", percentage: "" });
            const [editingId, setEditingId] = useState(null);

            const openEdit = (c) => { setData({ name: c.name, percentage: c.percentage }); setEditingId(c.id); setIsModalOpen(true); };
            const openNew = () => { setData({ name: "", percentage: "" }); setEditingId(null); setIsModalOpen(true); };
            const handleSave = () => {
                if(data.name && data.percentage) {
                    const val = parseFloat(data.percentage.toString().replace(',','.'));
                    if(editingId) onUpdateCost({ id: editingId, name: data.name, percentage: val });
                    else onAddCost({ name: data.name, percentage: val });
                    setIsModalOpen(false);
                }
            };
            const total = costs.reduce((a, b) => a + b.percentage, 0);

            return (
                <div className="p-6 pb-24 min-h-screen bg-gray-50 relative">
                    <div className="flex items-center gap-3 mb-6"><button onClick={() => setScreen('home')} className="p-2 bg-white rounded-lg shadow-sm border border-gray-100 text-gray-600"><IconWrapper name="arrow-left" size={20}/></button><h1 className="text-xl font-bold">Custos Variáveis</h1></div>
                    <div className="bg-violet-600 rounded-2xl p-6 text-white mb-6 shadow-lg"><p className="text-violet-200 text-sm">Total Mark-up</p><h2 className="text-3xl font-bold">{total.toFixed(2)}%</h2></div>
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">{costs.map(c => (
                        <div key={c.id} onClick={() => openEdit(c)} className="p-4 flex justify-between items-center border-b last:border-0 cursor-pointer hover:bg-gray-50">
                            <span className="font-medium text-gray-700">{c.name}</span>
                            <div className="flex gap-4 items-center"><span className="font-bold">{c.percentage.toFixed(2)}%</span><button onClick={(e) => {e.stopPropagation(); onDeleteCost(c.id)}} className="text-gray-300 hover:text-red-500"><IconWrapper name="trash-2" size={18}/></button></div>
                        </div>
                    ))}</div>
                    <button onClick={openNew} className="mt-6 w-full py-4 bg-violet-600 text-white rounded-xl font-bold shadow-lg flex justify-center gap-2"><IconWrapper name="plus" size={20}/> Adicionar Taxa</button>
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                                <h3 className="font-bold mb-4">{editingId ? 'Editar' : 'Nova'} Taxa</h3>
                                <input value={data.name} onChange={(e) => setData({...data, name: capitalize(e.target.value)})} placeholder="Nome" className="w-full p-3 border rounded-lg mb-4"/>
                                <input type="number" step="0.01" value={data.percentage} onChange={(e) => setData({...data, percentage: e.target.value})} placeholder="%" className="w-full p-3 border rounded-lg mb-4"/>
                                <div className="flex gap-3"><button onClick={() => setIsModalOpen(false)} className="flex-1 py-3 bg-gray-100 rounded-lg">Cancelar</button><button onClick={handleSave} className="flex-1 py-3 bg-violet-600 text-white rounded-lg">Salvar</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const SearchScreen = ({ setScreen, products, clients, onDeleteProduct, onEditProduct, onDuplicateProduct }) => {
            const [searchTerm, setSearchTerm] = useState("");
            const getClientName = (id) => { const c = clients.find(cl => cl.id == id); return c ? c.name : 'Desconhecido'; };
            const filtered = products.filter(p => 
                (p.reference || "").toLowerCase().includes(searchTerm.toLowerCase()) || 
                (p.description || "").toLowerCase().includes(searchTerm.toLowerCase()) ||
                getClientName(p.clientId).toLowerCase().includes(searchTerm.toLowerCase())
            );
            const displayList = (searchTerm ? filtered : products).slice().reverse();

            return (
                <div className="p-6 pb-24 min-h-screen bg-gray-50">
                    <div className="flex items-center gap-3 mb-6"><h1 className="text-xl font-bold text-slate-800">Pesquisar / Produtos</h1></div>
                    <div className="relative mb-6"><input type="text" placeholder="Buscar..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full p-4 pl-12 bg-white border border-gray-200 rounded-xl shadow-sm outline-none focus:ring-2 focus:ring-blue-500" /><div className="absolute left-4 top-4 text-gray-400"><IconWrapper name="search" size={20} /></div></div>
                    <div className="space-y-3">
                        {displayList.length === 0 ? <p className="text-center text-gray-400 py-10">Nada encontrado.</p> : 
                        displayList.map(prod => (
                            <div key={prod.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col gap-3">
                                <div>
                                    <div className="flex items-center gap-2 mb-1"><span className="font-bold text-gray-800">{prod.reference}</span><span className="text-gray-400">•</span><span className="text-gray-600 text-sm">{prod.description}</span></div>
                                    <div className="text-xs text-gray-500 mb-2">{getClientName(prod.clientId)} • {prod.date}</div>
                                    <div className="inline-flex items-center gap-2 bg-green-50 px-2 py-1 rounded text-green-700 font-bold text-sm border border-green-100">R$ {(prod.suggestedPrice || 0).toFixed(2)}</div>
                                </div>
                                <div className="flex justify-end gap-2 border-t pt-3">
                                    <button onClick={(e) => {e.stopPropagation(); onEditProduct(prod)}} className="p-2 text-blue-500 hover:bg-blue-50 rounded"><IconWrapper name="edit" size={18}/></button>
                                    <button onClick={(e) => {e.stopPropagation(); onDuplicateProduct(prod)}} className="p-2 text-gray-500 hover:bg-gray-50 rounded"><IconWrapper name="copy" size={18}/></button>
                                    <button onClick={(e) => {e.stopPropagation(); onDeleteProduct(prod.id)}} className="p-2 text-gray-300 hover:text-red-500 rounded"><IconWrapper name="trash-2" size={18}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const CalculatorScreen = ({ setScreen, clients, fabrics, fixedCosts, variableCosts, onSaveProduct, initialData, products }) => {
            const [step, setStep] = useState(1);
            const [refError, setRefError] = useState("");
            const [product, setProduct] = useState({
                reference: "", description: "", clientId: "", selectedFabrics: [], 
                sewingCost: 0, printingCost: 0, trimsCost: 0, cuttingCost: 0, extraServices: [], clientInputsCost: 0,
                taxPct: 0, commissionPct: 0, marginPct: 0, freightPct: 0, expensesPct: 0, financialPct: 0, negotiationPct: 0
            });

            useEffect(() => {
                if (initialData) setProduct({ ...initialData, extraServices: initialData.extraServices || [] });
            }, [initialData]);

            useEffect(() => {
                if (product.reference) {
                    const isDup = products.some(p => p.reference === product.reference.toUpperCase() && p.id !== product.id);
                    setRefError(isDup ? "Referência já existe!" : "");
                }
            }, [product.reference, products, product.id]);

            const handleClientChange = (e) => {
                const cid = e.target.value;
                let updates = { clientId: cid };
                if(cid) {
                    const c = clients.find(cli => cli.id === cid);
                    if(c) {
                        updates = { ...updates, taxPct: c.tax, commissionPct: c.commission, marginPct: c.margin, freightPct: c.freight, expensesPct: c.expenses, financialPct: c.financial, negotiationPct: c.negotiation, clientInputsCost: c.inputs ? c.inputs.reduce((a,b)=>a+(b.cost||0),0) : 0 };
                    }
                }
                setProduct(prev => ({ ...prev, ...updates }));
            };

            const handleRefChange = (val) => {
                const upper = val.toUpperCase();
                setProduct(prev => {
                    const oldRef = prev.reference;
                    let desc = prev.description;
                    const pOld = `${oldRef} - `; const pNew = `${upper} - `;
                    if(desc === "" || desc.startsWith(pOld)) desc = pNew + (desc.startsWith(pOld) ? desc.slice(pOld.length) : desc);
                    return { ...prev, reference: upper, description: desc };
                });
            };

            const addFabric = () => setProduct(prev => ({...prev, selectedFabrics: [...prev.selectedFabrics, { id: Date.now(), fabricId: "", consumption: 0, yield: 0, trimMeasure: 0, trimWidth: 0, trimWeight: 0, consumptionCm: 0, consumptionPc: 0, consumptionGrams: 0, consumptionKgMt: 0, value: 0 }]}));
            const removeFabric = (idx) => setProduct(prev => ({...prev, selectedFabrics: prev.selectedFabrics.filter((_, i) => i !== idx)}));
            
            const updateFabric = (idx, field, val) => {
                const newFabs = [...product.selectedFabrics];
                const numeric = ['yield', 'trimMeasure', 'trimWidth', 'trimWeight', 'consumptionCm', 'consumptionPc', 'consumptionGrams', 'consumptionKgMt', 'value'];
                const v = numeric.includes(field) ? (parseFloat(val)||0) : val;
                newFabs[idx][field] = v;

                if (field === 'fabricId') {
                    const f = fabrics.find(fb => fb.id === v);
                    if(f) newFabs[idx].yield = f.yield || 0;
                }

                // Cálculos
                let grams = newFabs[idx].consumptionGrams || 0;
                let kgmt = newFabs[idx].consumptionKgMt || 0;

                if(['consumptionCm','yield','consumptionPc','trimWeight','fabricId'].includes(field)) {
                    const cm = newFabs[idx].consumptionCm||0, yld = newFabs[idx].yield||0, pc = newFabs[idx].consumptionPc||0, trim = newFabs[idx].trimWeight||0;
                    if(pc > 0) {
                        grams = (((cm * yld) / pc) + trim) / 0.97;
                        newFabs[idx].consumptionGrams = parseFloat(grams.toFixed(3));
                    }
                } else if (field === 'consumptionGrams') grams = v;

                if(grams > 0) { kgmt = 1000/grams; newFabs[idx].consumptionKgMt = parseFloat(kgmt.toFixed(3)); }
                if(field === 'consumptionKgMt') kgmt = v;

                const fid = newFabs[idx].fabricId;
                const fab = fabrics.find(f => f.id === fid);
                if(fab && kgmt > 0) {
                    newFabs[idx].value = (fab.price / kgmt) / 0.97;
                }

                setProduct(prev => ({...prev, selectedFabrics: newFabs}));
            };

            const addServiceRow = () => {
                setProduct(prev => ({
                    ...prev,
                    extraServices: [
                        ...prev.extraServices, 
                        { id: Date.now(), name: "", cost: 0 }
                    ]
                }));
            };

            const updateServiceRow = (index, field, value) => {
                const newServices = [...product.extraServices];
                newServices[index][field] = field === 'cost' ? (parseFloat(value) || 0) : capitalize(value);
                setProduct(prev => ({ ...prev, extraServices: newServices }));
            };

            const removeServiceRow = (index) => {
                const newServices = product.extraServices.filter((_, i) => i !== index);
                setProduct(prev => ({ ...prev, extraServices: newServices }));
            };

            const calcTotals = () => {
                let fabTotal = product.selectedFabrics.reduce((a, b) => a + b.value, 0);
                let extraTotal = product.extraServices.reduce((a, b) => a + b.cost, 0);
                const rawDirect = fabTotal + product.sewingCost + product.printingCost + product.trimsCost + product.cuttingCost + extraTotal + product.clientInputsCost;
                const totalDirect = rawDirect / 0.97; // Quebra 3%
                
                const group1 = (product.taxPct + product.commissionPct + product.expensesPct + product.marginPct + product.freightPct)/100;
                const group2 = (product.negotiationPct + product.financialPct)/100;
                const div1 = 1 - group1;
                const div2 = 1 - group2;
                
                let price = 0;
                if(div1 > 0 && div2 > 0) price = (totalDirect / div1) / div2;

                return { fabTotal, totalDirect, suggestedPrice: price, totalDirectCost: totalDirect };
            };
            const t = calcTotals();

            return (
                <div className="p-6 pb-24 min-h-screen bg-gray-50">
                    <div className="flex items-center gap-3 mb-6"><button onClick={() => setScreen('home')} className="p-2 bg-white rounded-lg shadow-sm border border-gray-100 text-gray-600"><IconWrapper name="arrow-left" size={20}/></button><h1 className="text-xl font-bold">{initialData && initialData.id ? 'Editar' : 'Novo'} Cálculo</h1></div>
                    
                    <div className="flex gap-2 mb-6">
                        {[1,2,3].map(i => <div key={i} className={`h-1 flex-1 rounded-full ${step >= i ? 'bg-blue-600' : 'bg-gray-200'}`}></div>)}
                    </div>

                    {step === 1 && (
                        <div className="space-y-4 animate-fade-in">
                            <div className="bg-white p-5 rounded-2xl shadow-sm border space-y-4">
                                <h3 className="font-bold flex items-center gap-2">Identificação</h3>
                                <input value={product.reference} onChange={e => handleRefChange(e.target.value)} className={`w-full p-3 border rounded-lg ${refError ? 'border-red-500' : ''} uppercase`} placeholder="Referência (Ex: 21115)"/>
                                {refError && <p className="text-red-500 text-xs">{refError}</p>}
                                <input value={product.description} onChange={e => setProduct({...product, description: capitalize(e.target.value)})} className="w-full p-3 border rounded-lg" placeholder="Descrição"/>
                                <select value={product.clientId} onChange={handleClientChange} className="w-full p-3 border rounded-lg"><option value="">Selecione Cliente...</option>{clients.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select>
                            </div>
                            <button onClick={() => !refError && setStep(2)} disabled={!!refError} className={`w-full py-4 rounded-xl font-bold text-white ${refError ? 'bg-gray-300' : 'bg-blue-600'}`}>Próximo</button>
                        </div>
                    )}

                    {step === 2 && (
                        <div className="space-y-4 animate-fade-in">
                            <div className="bg-white p-5 rounded-2xl shadow-sm border">
                                <div className="flex justify-between mb-4"><h3 className="font-bold">Tecidos</h3><button onClick={addFabric} className="text-xs font-bold text-blue-600">+ Adicionar</button></div>
                                <div className="space-y-4">
                                    {product.selectedFabrics.map((f, i) => (
                                        <div key={f.id} className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                            <div className="flex justify-between mb-2">
                                                <select value={f.fabricId} onChange={e => updateFabric(i, 'fabricId', e.target.value)} className="bg-transparent font-bold text-sm w-full"><option value="">Selecione tecido...</option>{fabrics.map(fb=><option key={fb.id} value={fb.id}>{fb.name} - R$ {fb.price}</option>)}</select>
                                                <button onClick={() => removeFabric(i)} className="text-red-400"><IconWrapper name="x" size={16}/></button>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2 mb-2">
                                                <div><label className="text-[10px] text-gray-500">Rendimento</label><input type="number" step="0.01" value={f.yield||''} onChange={e=>updateFabric(i,'yield',e.target.value)} className="w-full p-1 border rounded text-sm"/></div>
                                                <div><label className="text-[10px] text-gray-500">Peso Friso (g)</label><input type="number" step="0.1" value={f.trimWeight||''} onChange={e=>updateFabric(i,'trimWeight',e.target.value)} className="w-full p-1 border rounded text-sm"/></div>
                                                <div><label className="text-[10px] text-gray-500">Medida Friso (cm)</label><input type="number" step="0.1" value={f.trimMeasure||''} onChange={e=>updateFabric(i,'trimMeasure',e.target.value)} className="w-full p-1 border rounded text-sm"/></div>
                                                <div><label className="text-[10px] text-gray-500">Largura Friso</label><input type="number" step="0.1" value={f.trimWidth||''} onChange={e=>updateFabric(i,'trimWidth',e.target.value)} className="w-full p-1 border rounded text-sm"/></div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2 mb-2 pt-2 border-t">
                                                <div><label className="text-[10px] text-gray-500">Consumo (cm)</label><input type="number" step="0.1" value={f.consumptionCm||''} onChange={e=>updateFabric(i,'consumptionCm',e.target.value)} className="w-full p-1 border rounded text-sm"/></div>
                                                <div><label className="text-[10px] text-gray-500">Consumo (pç)</label><input type="number" step="1" value={f.consumptionPc||''} onChange={e=>updateFabric(i,'consumptionPc',e.target.value)} className="w-full p-1 border rounded text-sm"/></div>
                                                <div><label className="text-[10px] text-gray-500">Gramas</label><input type="number" value={f.consumptionGrams||''} readOnly className="w-full p-1 bg-gray-100 border rounded text-sm"/></div>
                                                <div><label className="text-[10px] text-yellow-600 font-bold">Kg/Mt</label><input type="number" value={f.consumptionKgMt||''} onChange={e=>updateFabric(i,'consumptionKgMt',e.target.value)} className="w-full p-1 bg-white border border-yellow-200 rounded text-sm font-bold"/></div>
                                            </div>
                                            <div className="flex justify-between bg-gray-100 p-2 rounded"><span className="text-xs font-bold">CUSTO</span><span className="font-bold text-sm">R$ {f.value.toFixed(2)}</span></div>
                                        </div>
                                    ))}
                                    <div className="pt-2 border-t flex justify-between"><span className="text-sm">Total Tecidos</span><span className="font-bold">R$ {t.fabTotal.toFixed(2)}</span></div>
                                </div>
                            </div>
                            <div className="bg-white p-5 rounded-2xl shadow-sm border">
                                <h3 className="font-bold mb-4">Serviços</h3>
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <input type="number" step="0.01" placeholder="Costura" value={product.sewingCost} onChange={e => setProduct({...product, sewingCost: parseFloat(e.target.value)||0})} className="p-2 border rounded"/>
                                    <input type="number" step="0.01" placeholder="Estampa" value={product.printingCost} onChange={e => setProduct({...product, printingCost: parseFloat(e.target.value)||0})} className="p-2 border rounded"/>
                                    <input type="number" step="0.01" placeholder="Aviamentos" value={product.trimsCost} onChange={e => setProduct({...product, trimsCost: parseFloat(e.target.value)||0})} className="p-2 border rounded"/>
                                    <input type="number" step="0.01" placeholder="Corte" value={product.cuttingCost} onChange={e => setProduct({...product, cuttingCost: parseFloat(e.target.value)||0})} className="p-2 border rounded"/>
                                </div>
                                <div className="bg-orange-50 p-3 rounded flex justify-between items-center">
                                    <span className="text-xs font-bold text-orange-700">Insumos Cliente</span>
                                    <input type="number" step="0.01" value={product.clientInputsCost} onChange={e => setProduct({...product, clientInputsCost: parseFloat(e.target.value)||0})} className="w-20 p-1 border rounded text-right text-sm"/>
                                </div>
                                <div className="mt-2 pt-2 border-t">
                                    <div className="flex justify-between mb-2"><span className="text-xs font-bold text-gray-400">OUTROS</span><button onClick={() => setProduct(prev => ({...prev, extraServices: [...prev.extraServices, {id: Date.now(), name:"", cost:0}]}))} className="text-xs text-blue-600 font-bold">+ Add</button></div>
                                    {product.extraServices.map((s, i) => (
                                        <div key={s.id} className="flex gap-2 mb-2">
                                            <input className="flex-1 p-1 border rounded text-sm" placeholder="Nome" value={s.name} onChange={e => { const ns = [...product.extraServices]; ns[i].name = e.target.value; setProduct({...product, extraServices: ns}); }}/>
                                            <input className="w-20 p-1 border rounded text-sm" type="number" value={s.cost} onChange={e => { const ns = [...product.extraServices]; ns[i].cost = parseFloat(e.target.value)||0; setProduct({...product, extraServices: ns}); }}/>
                                            <button onClick={() => setProduct(prev => ({...prev, extraServices: prev.extraServices.filter((_, idx) => idx !== i)}))} className="text-red-400"><IconWrapper name="trash-2" size={16}/></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="flex gap-3"><button onClick={() => setStep(1)} className="flex-1 py-4 bg-gray-100 rounded-xl font-bold">Voltar</button><button onClick={() => setStep(3)} className="flex-1 py-4 bg-blue-600 text-white rounded-xl font-bold">Calcular</button></div>
                        </div>
                    )}

                    {step === 3 && (
                        <div className="space-y-4 animate-fade-in">
                            <div className="bg-slate-800 p-6 rounded-2xl text-center text-white shadow-xl">
                                <p className="text-slate-300 text-sm">Preço Sugerido</p>
                                <h2 className="text-4xl font-bold mb-2">R$ {t.suggestedPrice.toFixed(2)}</h2>
                                <div className="bg-slate-700 inline-block px-3 py-1 rounded-full text-xs">Custo Prod: R$ {t.totalDirectCost.toFixed(2)} (c/ 3% quebra)</div>
                            </div>
                            <div className="bg-white p-5 rounded-2xl shadow-sm border space-y-3">
                                <h3 className="font-bold mb-2">Mark-up</h3>
                                <div className="flex justify-between items-center text-sm"><span>Impostos</span><div className="flex items-center gap-1 w-20"><input type="number" value={product.taxPct} onChange={(e) => setProduct({...product, taxPct: parseFloat(e.target.value)||0})} className="w-full p-1 border rounded text-right text-sm" /><span>%</span></div></div>
                                <div className="flex justify-between items-center text-sm"><span>Comissão</span><div className="flex items-center gap-1 w-20"><input type="number" value={product.commissionPct} onChange={(e) => setProduct({...product, commissionPct: parseFloat(e.target.value)||0})} className="w-full p-1 border rounded text-right text-sm" /><span>%</span></div></div>
                                <div className="flex justify-between items-center text-sm"><span>MD</span><div className="flex items-center gap-1 w-20"><input type="number" value={product.expensesPct} onChange={(e) => setProduct({...product, expensesPct: parseFloat(e.target.value)||0})} className="w-full p-1 border rounded text-right text-sm" /><span>%</span></div></div>
                                <div className="flex justify-between items-center text-sm"><span>Financeiro</span><div className="flex items-center gap-1 w-20"><input type="number" value={product.financialPct} onChange={(e) => setProduct({...product, financialPct: parseFloat(e.target.value)||0})} className="w-full p-1 border rounded text-right text-sm" /><span>%</span></div></div>
                                <div className="flex justify-between items-center text-sm"><span>Negociação</span><div className="flex items-center gap-1 w-20"><input type="number" value={product.negotiationPct} onChange={(e) => setProduct({...product, negotiationPct: parseFloat(e.target.value)||0})} className="w-full p-1 border rounded text-right text-sm" /><span>%</span></div></div>
                                <div className="flex justify-between items-center text-sm font-bold text-green-600"><span>Lucro</span><div className="flex items-center gap-1 w-20"><input type="number" value={product.marginPct} onChange={(e) => setProduct({...product, marginPct: parseFloat(e.target.value)||0})} className="w-full p-1 border rounded text-right text-sm font-bold text-green-600" /><span>%</span></div></div>
                                <div className="flex justify-between items-center text-sm"><span>Frete</span><div className="flex items-center gap-1 w-20"><input type="number" value={product.freightPct} onChange={(e) => setProduct({...product, freightPct: parseFloat(e.target.value)||0})} className="w-full p-1 border rounded text-right text-sm" /><span>%</span></div></div>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => setStep(2)} className="flex-1 py-4 bg-gray-100 rounded-xl font-bold">Voltar</button>
                                <button onClick={() => { 
                                    onSaveProduct({
                                        ...product, 
                                        ...t, 
                                        id: product.id || Date.now(), 
                                        date: new Date().toLocaleString()
                                    }); 
                                    setScreen('search'); 
                                }} className="flex-1 py-4 bg-green-600 text-white rounded-xl font-bold">Salvar</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const SettingsScreen = ({ setScreen }) => {
            const inputFileRef = useRef(null);
            
            const handleExport = () => {
                const data = {
                    app_clients: localStorage.getItem('app_clients'),
                    app_fabrics: localStorage.getItem('app_fabrics'),
                    app_fixedCosts: localStorage.getItem('app_fixedCosts'),
                    app_variableCosts: localStorage.getItem('app_variableCosts'),
                    app_products: localStorage.getItem('app_products'),
                };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_lpm_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.app_clients) localStorage.setItem('app_clients', data.app_clients);
                        if (data.app_fabrics) localStorage.setItem('app_fabrics', data.app_fabrics);
                        if (data.app_fixedCosts) localStorage.setItem('app_fixedCosts', data.app_fixedCosts);
                        if (data.app_variableCosts) localStorage.setItem('app_variableCosts', data.app_variableCosts);
                        if (data.app_products) localStorage.setItem('app_products', data.app_products);
                        alert('Backup restaurado com sucesso! A página será recarregada.');
                        window.location.reload();
                    } catch (err) {
                        alert('Erro ao ler arquivo de backup.');
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="p-6 pb-24 min-h-screen bg-gray-50">
                    <div className="flex items-center gap-3 mb-6"><button onClick={() => setScreen('home')} className="p-2 bg-white rounded-lg shadow-sm border border-gray-100 text-gray-600"><IconWrapper name="arrow-left" size={20}/></button><h1 className="text-xl font-bold">Ajustes & Backup</h1></div>
                    
                    <div className="bg-white p-6 rounded-2xl shadow-sm border space-y-6">
                        <div>
                            <h3 className="font-bold text-gray-800 mb-2">Exportar Dados</h3>
                            <p className="text-sm text-gray-500 mb-3">Salve todos os seus cadastros e produtos em um arquivo seguro no seu computador.</p>
                            <button onClick={handleExport} className="w-full py-3 bg-blue-50 text-blue-600 font-bold rounded-lg border border-blue-100 flex items-center justify-center gap-2 hover:bg-blue-100 transition-colors">
                                <IconWrapper name="download" size={20} /> Fazer Backup
                            </button>
                        </div>
                        
                        <div className="pt-6 border-t border-gray-100">
                            <h3 className="font-bold text-gray-800 mb-2">Restaurar Backup</h3>
                            <p className="text-sm text-gray-500 mb-3">Carregue um arquivo de backup anterior para recuperar seus dados.</p>
                            <input type="file" ref={inputFileRef} onChange={handleImport} style={{display:'none'}} accept=".json"/>
                            <button onClick={() => inputFileRef.current.click()} className="w-full py-3 bg-gray-50 text-gray-600 font-bold rounded-lg border border-gray-200 flex items-center justify-center gap-2 hover:bg-gray-100 transition-colors">
                                <IconWrapper name="upload" size={20} /> Carregar Arquivo
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [currentScreen, setCurrentScreen] = useStickyState('home', 'app_screen');
            const [products, addProduct, updateProduct, deleteProduct] = useData('products', []);
            const [editingProduct, setEditingProduct] = useState(null); 
            
            // Dados Persistentes
            const [clients, addClient, updateClient, deleteClient] = useData('clients', [
                { id: 1, name: "Torra Torra", commission: 5.0, tax: 14.0, margin: 15.0, freight: 3.0, expenses: 0.0, financial: 0.0, negotiation: 0.0, inputs: [], extraFields: [] },
                { id: 2, name: "Riachuelo", commission: 6.0, tax: 14.0, margin: 18.0, freight: 2.5, expenses: 0.0, financial: 0.0, negotiation: 0.0, inputs: [], extraFields: [] }
            ]);
            
            const [fabrics, addFabric, updateFabric, deleteFabric] = useData('fabrics', [
                { id: 1, name: "Suplex - 92%PES 8%PEU", price: 20.00, type: "Kg", yield: 3.5, yarns: [], extraFields: [], weavingCost: 0, weavingBreakage: 0, dyeingCost: 0, dyeingBreakage: 0, colorCost1: 0, colorCost2: 0, colorCost3: 0 }
            ]);

            const [fixedCosts, addFixedCost, updateFixedCost, deleteFixedCost] = useData('fixedCosts', [
                { id: 1, name: "Aluguel", value: 2500.00 },
                { id: 2, name: "Energia", value: 850.00 }
            ]);

            const [variableCosts, addVariableCost, updateVariableCost, deleteVariableCost] = useData('variableCosts', [
                { id: 1, name: "Imposto", percentage: 14.00 },
                { id: 2, name: "Comissão", percentage: 5.00 }
            ]);

            const handleSaveProduct = (product) => {
                const exists = products.some(p => p.id === product.id);
                if (exists) updateProduct(product);
                else addProduct(product);
                setEditingProduct(null);
            };

            const handleEditProduct = (p) => { setEditingProduct(p); setCurrentScreen('calculator'); };
            const handleDuplicateProduct = (p) => { const { id, ...data } = p; setEditingProduct({ ...data, id: null, reference: "", description: p.description + " (Cópia)" }); setCurrentScreen('calculator'); };

            const renderScreen = () => {
                switch(currentScreen) {
                    case 'home': return <HomeScreen setScreen={setCurrentScreen} />;
                    case 'calculator': return <CalculatorScreen setScreen={setCurrentScreen} clients={clients} fabrics={fabrics} fixedCosts={fixedCosts} variableCosts={variableCosts} onSaveProduct={handleSaveProduct} initialData={editingProduct} products={products} />;
                    case 'clients': return <ClientsScreen setScreen={setCurrentScreen} clients={clients} onAddClient={addClient} onDeleteClient={deleteClient} onUpdateClient={updateClient} />;
                    case 'fabrics': return <FabricsScreen setScreen={setCurrentScreen} fabrics={fabrics} onAddFabric={addFabric} onDeleteFabric={deleteFabric} onUpdateFabric={updateFabric} />;
                    case 'fixedCosts': return <FixedCostsScreen setScreen={setCurrentScreen} costs={fixedCosts} onAddCost={addFixedCost} onUpdateCost={updateFixedCost} onDeleteCost={deleteFixedCost} />;
                    case 'variableCosts': return <VariableCostsScreen setScreen={setCurrentScreen} costs={variableCosts} onAddCost={addVariableCost} onUpdateCost={updateVariableCost} onDeleteCost={deleteVariableCost} />;
                    case 'search': return <SearchScreen setScreen={setCurrentScreen} products={products} clients={clients} onDeleteProduct={deleteProduct} onEditProduct={handleEditProduct} onDuplicateProduct={handleDuplicateProduct} />;
                    case 'settings': return <SettingsScreen setScreen={setCurrentScreen} />;
                    default: return <HomeScreen setScreen={setCurrentScreen} />;
                }
            };

            return (
                <div className="app-container font-sans bg-gray-50">
                    {renderScreen()}
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-3 flex justify-around items-center max-w-[480px] mx-auto z-50">
                        <button onClick={() => setCurrentScreen('home')} className={`flex flex-col items-center gap-1 ${currentScreen === 'home' ? 'text-blue-600' : 'text-gray-400'}`}><IconWrapper name="home" size={20}/><span className="text-[10px] font-medium">Início</span></button>
                        <button onClick={() => setCurrentScreen('clients')} className={`flex flex-col items-center gap-1 ${currentScreen === 'clients' ? 'text-blue-600' : 'text-gray-400'}`}><IconWrapper name="users" size={20}/><span className="text-[10px] font-medium">Clientes</span></button>
                        <div className="relative -top-5"><button onClick={() => { setEditingProduct(null); setCurrentScreen('calculator'); }} className="bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition-colors"><IconWrapper name="plus" size={24}/></button></div>
                        <button onClick={() => setCurrentScreen('fabrics')} className={`flex flex-col items-center gap-1 ${currentScreen === 'fabrics' ? 'text-blue-600' : 'text-gray-400'}`}><IconWrapper name="scissors" size={20}/><span className="text-[10px] font-medium">Tecidos</span></button>
                        <button onClick={() => setCurrentScreen('search')} className={`flex flex-col items-center gap-1 ${currentScreen === 'search' ? 'text-blue-600' : 'text-gray-400'}`}><IconWrapper name="search" size={20}/><span className="text-[10px] font-medium">Pesquisar</span></button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
